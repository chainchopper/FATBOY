<div class="profile-container">
  <div *ngIf="profile$ | async as profile; else notFound">
    <div class="profile-card">
      <div class="profile-header">
        <img [src]="profile.avatar_url || 'https://api.dicebear.com/8.x/initials/svg?seed=' + (profile.first_name || 'A')" alt="User Avatar" class="avatar">
        <button *ngIf="isCurrentUserProfile" class="edit-profile-btn" routerLink="/profile/edit">Edit Profile</button>
      </div>
      <h2>{{ profile.first_name }} {{ profile.last_name }}</h2>
      <p *ngIf="profile.bio" class="bio">{{ profile.bio }}</p>
      <p *ngIf="isCurrentUserProfile" class="email">{{ profile.id }}</p> <!-- Email is not on the public profile table -->
      
      <div class="profile-section stats-section" *ngIf="(leaderboardStats$ | async) as stats">
        <div class="stat-item">
          <span class="stat-value">{{ stats.rank || 'N/A' }}</span>
          <span class="stat-label">Global Rank</span>
        </div>
        <div class="stat-item">
          <span class="stat-value">{{ stats.score || 0 }}</span>
          <span class="stat-label">Total Score</span>
        </div>
        <button class="leaderboard-btn" routerLink="/leaderboard">View Leaderboard</button>
      </div>

      <div class="profile-section">
        <h3>{{ isCurrentUserProfile ? 'Your' : profile.first_name + "'s" }} Badges</h3>
        <div class="badges-grid">
          <div *ngFor="let badge of (badges$ | async)" class="badge-item" [class.unlocked]="badge.unlocked">
            <span class="badge-icon">{{ badge.icon }}</span>
            <span class="badge-name">{{ badge.name }}</span>
          </div>
        </div>
      </div>

      <div class="profile-section">
        <h3>Community Contributions</h3>
        <div *ngIf="(contributions$ | async) as contributions; else loadingContributions">
          <div *ngIf="contributions.length > 0" class="contributions-list">
            <div *ngFor="let contribution of contributions" class="contribution-item">
              <div class="contribution-info">
                <span class="contribution-name">{{ contribution.product_name }}</span>
                <span class="contribution-brand">{{ contribution.brand }}</span>
              </div>
              <div class="contribution-status status-{{ contribution.status }}">
                {{ contribution.status | titlecase }}
              </div>
            </div>
          </div>
          <div *ngIf="contributions.length === 0" class="empty-state-small">
            <p>This user hasn't made any contributions yet.</p>
          </div>
        </div>
        <ng-template #loadingContributions>
          <p>Loading contributions...</p>
        </ng-template>
      </div>

      <div class="profile-section">
        <h3>Recent Activity</h3>
        <div *ngIf="(activityFeed$ | async) as feed; else loadingActivity">
          <div *ngIf="feed.length > 0" class="activity-feed-list">
            <div *ngFor="let item of feed" class="activity-item">
              <div class="activity-icon">
                <lucide-icon [name]="getIconForActivity(item.activity_type)" [size]="20"></lucide-icon>
              </div>
              <div class="activity-content">
                <p>{{ item.activity_description }}</p>
                <span class="timestamp">{{ item.created_at | date:'short' }}</span>
              </div>
            </div>
          </div>
          <div *ngIf="feed.length === 0" class="empty-state-small">
            <p>This user has no recent activity.</p>
          </div>
        </div>
        <ng-template #loadingActivity>
          <p>Loading activity...</p>
        </ng-template>
      </div>
      
    </div>
  </div>
  
  <ng-template #notFound>
    <div class="empty-state">
      <p>User profile not found or you are not logged in.</p>
    </div>
  </ng-template>
</div>