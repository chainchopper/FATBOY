<div class="product-card" [class.purchased]="isPurchased">
  <div class="card-header" (click)="toggleExpand()">
    <div class="product-info-main">
      <img [src]="product.image || 'https://via.placeholder.com/100?text=No+Image'" alt="{{product.name}}" class="product-image">
      <div class="product-details-main">
        <h3 class="product-name">{{ product.name }}</h3>
        <p class="product-brand">{{ product.brand }}</p>
      </div>
    </div>
    <div class="card-actions-header">
      <input *ngIf="showCheckbox" type="checkbox" [checked]="isPurchased" (change)="onTogglePurchased()" (click)="$event.stopPropagation()">
      <button class="expand-toggle" [class.expanded]="isExpanded">
        <lucide-icon name="chevron-down" [size]="20"></lucide-icon>
      </button>
    </div>
  </div>

  <div class="card-expanded-content" *ngIf="isExpanded">
    <div class="metadata-section">
      <h4>Ingredients:</h4>
      <p>{{ product.ingredients.join(', ') || 'No ingredients listed.' }}</p>
    </div>
    <div class="metadata-section">
      <h4>Verdict:</h4>
      <p [class.good-verdict]="product.verdict === 'good'" [class.bad-verdict]="product.verdict === 'bad'">
        {{ product.verdict === 'good' ? 'Fat Boy Approved!' : 'Contains Avoided Items!' }}
      </p>
      <div *ngIf="product.flaggedIngredients && product.flaggedIngredients.length > 0">
        <strong>Flagged:</strong> {{ product.flaggedIngredients.join(', ') }}
      </div>
    </div>
    <div class="metadata-section" *ngIf="product.calories">
      <h4>Calories:</h4>
      <p>{{ product.calories }} kcal per serving</p>
    </div>
    <div class="metadata-section" *ngIf="product.categories && product.categories.length > 0">
      <h4>Categories:</h4>
      <div class="category-tags">
        <span *ngFor="let category of product.categories" class="category-tag">
          <app-food-icon [category]="category"></app-food-icon>
          {{ category }}
        </span>
      </div>
    </div>
    <div class="metadata-section" *ngIf="product.ocrText">
      <h4>Raw OCR Text:</h4>
      <p class="ocr-text">{{ product.ocrText }}</p>
    </div>
  </div>

  <div class="card-footer-actions">
    <button *ngIf="showShareButton" (click)="onShare()" class="action-btn share-btn" title="Share">
      <lucide-icon name="share-2" [size]="18"></lucide-icon>
    </button>
    <button *ngIf="showAddToShoppingListButton" (click)="onAddToShoppingList()" class="action-btn add-to-list-btn" title="Add to Shopping List">
      <lucide-icon name="shopping-cart" [size]="18"></lucide-icon>
    </button>
    <button *ngIf="showAddToFoodDiaryButton" (click)="onAddToFoodDiary()" class="action-btn add-to-diary-btn" title="Add to Food Diary">
      <lucide-icon name="book-open" [size]="18"></lucide-icon>
    </button>
    <button *ngIf="showRemoveButton" (click)="onRemove()" class="action-btn remove-btn" title="Remove">
      <lucide-icon name="trash-2" [size]="18"></lucide-icon>
    </button>
  </div>
</div>