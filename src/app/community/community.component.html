<div class="max-w-4xl mx-auto p-5 text-gray-100">
  <h2 class="text-center mb-4 text-3xl font-bold text-purple-400 text-shadow-[0_0_8px_#f038ff]">Community Hub</h2>
  <p class="text-center mb-8 text-gray-400">See what others are discovering, contribute your own finds, and check out the global activity!</p>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <div class="lg:col-span-2">
      <div class="text-center mb-8">
        <app-button variant="outline" (onClick)="toggleAddMode()" class="px-6 py-3 rounded-full text-base">
          {{ isAddingNewProduct ? 'Cancel Contribution' : 'Ôºã Add New Product' }}
        </app-button>
      </div>

      <div *ngIf="isAddingNewProduct" class="mb-8 p-5 bg-gray-900/80 border border-gray-700 rounded-xl">
        <div class="flex justify-center mb-8 bg-gray-900 rounded-full p-1 border border-gray-700">
          <button (click)="setMode('select')" class="flex-1 px-5 py-2 border-none bg-transparent text-gray-400 rounded-full cursor-pointer transition-all text-base" [ngClass]="{'active': mode === 'select', 'bg-purple-500 text-gray-900 shadow-md shadow-purple-500/50': mode === 'select'}">Contribute from History</button>
          <button (click)="setMode('manual')" class="flex-1 px-5 py-2 border-none bg-transparent text-gray-400 rounded-full cursor-pointer transition-all text-base" [ngClass]="{'active': mode === 'manual', 'bg-purple-500 text-gray-900 shadow-md shadow-purple-500/50': mode === 'manual'}">Add Manually</button>
        </div>

        <div *ngIf="mode === 'select'">
          <div *ngIf="(scanHistory$ | async) as history" class="flex flex-col gap-4">
            <div *ngIf="history.length === 0" class="bg-teal-900/20 border border-teal-500 rounded-lg p-4 text-center text-teal-400">
              <p>Your scan history is empty. Scan some products to contribute them!</p>
            </div>
            <div *ngFor="let product of history" class="flex items-center bg-gray-900 border border-gray-700 rounded-lg p-4 cursor-pointer transition-all hover:border-teal-500 hover:shadow-lg hover:shadow-teal-500/30 hover:-translate-y-1" (click)="selectProduct(product)">
              <img [src]="product.image || 'https://via.placeholder.com/50'" alt="{{ product.name }}" class="w-12 h-12 object-cover rounded-md mr-4">
              <div class="flex-grow">
                <h4 class="m-0 mb-1 text-gray-100">{{ product.name }}</h4>
                <p class="m-0 text-left text-gray-400 text-sm">{{ product.brand }}</p>
              </div>
              <app-button variant="ghost" size="icon" class="text-teal-400">‚Üí</app-button>
            </div>
          </div>
        </div>

        <div *ngIf="mode === 'manual'">
          <div *ngIf="isSubmitted" class="bg-teal-900/20 border border-teal-500 rounded-lg p-4 mb-5 text-center text-teal-400">
            <p>Thank you for your contribution! Your submission is pending review.</p>
          </div>
          
          <form (ngSubmit)="submitContribution()" class="pt-5">
            <div class="mb-6">
              <label for="productName" class="block mb-2.5 font-medium text-teal-400">Product Name</label>
              <app-input type="text" id="productName" [(ngModel)]="newContribution.product_name" name="productName" required></app-input>
            </div>
            <div class="mb-6">
              <label for="brand" class="block mb-2.5 font-medium text-teal-400">Brand</label>
              <app-input type="text" id="brand" [(ngModel)]="newContribution.brand" name="brand" required></app-input>
            </div>
            <div class="mb-6">
              <label for="ingredients" class="block mb-2.5 font-medium text-teal-400">Ingredients (comma separated)</label>
              <app-textarea id="ingredients" [(ngModel)]="newContribution.ingredients" name="ingredients" [rows]="4" required></app-textarea>
            </div>
            <div class="mb-6">
              <label for="notes" class="block mb-2.5 font-medium text-teal-400">Additional Notes (e.g., where you found it)</label>
              <app-textarea id="notes" [(ngModel)]="newContribution.notes" name="notes" [rows]="3"></app-textarea>
            </div>
            <app-button type="submit" variant="default" class="block mx-auto my-4 w-56 px-6 py-3 rounded-full text-base">Submit Contribution</app-button>
          </form>
        </div>
      </div>

      <div class="mt-8">
        <h3 class="text-xl font-semibold text-purple-400 mb-4 border-b border-gray-700 pb-2.5">Product Contributions</h3>
        <div *ngIf="communityContributions.length === 0 && !isAddingNewProduct" class="bg-teal-900/20 border border-teal-500 rounded-lg p-4 text-center text-teal-400">
          <p>No contributions yet. Be the first to share!</p>
        </div>
        <div *ngFor="let contribution of communityContributions" class="bg-gray-900/80 border border-gray-700 rounded-xl p-5 mb-5 shadow-lg" (click)="onContributionClick(contribution)">
          <div class="flex justify-between items-center mb-2.5">
            <h4 class="m-0 text-purple-400 text-lg">{{ contribution.product_name }}</h4>
            <span class="px-2.5 py-1 rounded-full text-xs font-bold text-gray-900" [ngClass]="{
              'bg-teal-500': contribution.status === 'approved',
              'bg-yellow-500': contribution.status === 'pending'
            }">{{ contribution.status | titlecase }}</span>
          </div>
          <p class="text-gray-400 text-sm mb-1.5">{{ contribution.brand }}</p>
          <div class="mb-1.5">
            <strong class="text-gray-400 text-sm">Ingredients:</strong>
            <div class="flex flex-wrap gap-2 mt-2">
                <span *ngFor="let ingredient of getIngredientsArray(contribution.ingredients)"
                      class="px-3 py-1 rounded-full text-xs border"
                      [ngClass]="{
                        'bg-purple-900/20 border-purple-500 text-purple-300': isCommunityIngredientFlagged(ingredient),
                        'bg-gray-800 border-gray-700 text-gray-400': !isCommunityIngredientFlagged(ingredient)
                      }">
                    {{ ingredient }}
                </span>
            </div>
          </div>
          <p class="text-gray-400 text-sm mb-1.5" *ngIf="contribution.notes"><strong>Notes:</strong> {{ contribution.notes }}</p>
          
          <div class="border-t border-gray-800 mt-4 pt-4 flex justify-between items-center text-xs text-gray-400">
            <div class="flex flex-col gap-1.5">
              <span class="font-bold text-gray-100">üë§ {{ contribution.profile.first_name || 'Anonymous' }}</span>
              <span *ngIf="contribution.metadata?.goal" class="text-gray-400">üéØ Goal: {{ contribution.metadata.goal | titlecase }}</span>
            </div>
            <div *ngIf="contribution.metadata?.rank" class="bg-gray-800 px-2.5 py-1.5 rounded-xl">
              üèÜ Rank #{{ contribution.metadata.rank }} ({{ contribution.metadata.score }} pts)
            </div>
          </div>

          <div class="flex gap-4 mt-4 pt-4 border-t border-gray-800">
            <app-button variant="outline" (onClick)="toggleLike(contribution); $event.stopPropagation()" class="px-2.5 py-1.5 rounded-full" [class.active]="currentUserHasLiked(contribution)" [class.bg-purple-500]="currentUserHasLiked(contribution)" [class.text-gray-900]="currentUserHasLiked(contribution)" [class.border-purple-500]="currentUserHasLiked(contribution)">üëç {{ contribution.likes.length }}</app-button>
            <span class="text-gray-400 flex items-center gap-1.5">üí¨ {{ contribution.comments.length }}</span>
          </div>

          <div class="mt-4 pt-4 border-t border-gray-800">
            <div *ngFor="let comment of contribution.comments" class="bg-gray-800 p-2 rounded-lg mb-2 text-sm">
              <strong class="text-purple-400">{{ comment.profile?.first_name || 'User' }}:</strong> {{ comment.text }}
            </div>
            <div class="flex gap-2.5 mt-2.5">
              <app-input type="text" [(ngModel)]="newCommentText[contribution.id]" placeholder="Add a comment..." (keydown.enter)="addComment(contribution.id)" [ngModelOptions]="{standalone: true}" class="flex-grow"></app-input>
              <app-button variant="default" (onClick)="addComment(contribution.id)">Post</app-button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="activity-feed bg-gray-900/80 border border-gray-700 rounded-xl p-5 h-fit">
      <h3 class="text-xl font-semibold text-teal-400 mt-0 mb-6 text-center">Global Activity</h3>
      <app-activity-feed 
        [activityFeed]="globalActivityFeed" 
        [isLoading]="isLoadingActivity"
        emptyMessage="No global activity yet. Be the first to do something!">
      </app-activity-feed>
    </div>
  </div>
</div>