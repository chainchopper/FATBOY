<div class="console-container">
  <div class="console-header">
    <h2>ü§ñ Fat Boy Assistant</h2>
    <button (click)="clearChatHistory()" class="clear-chat-btn">Clear Chat</button>
  </div>
  <div class="message-window" #messageWindow>
    <div *ngFor="let msg of messages" class="message" [ngClass]="'message-' + msg.sender">
      <ng-container *ngIf="msg.sender === 'agent'">
        <div class="avatar-container">
          <img [src]="msg.avatar" alt="Agent Avatar" class="avatar">
          <div class="status-dot" [ngClass]="agentStatus"></div>
        </div>
        <div class="agent-content">
          <div class="message-bubble">
            <p>{{ msg.text }}</p>
            <span class="timestamp">{{ msg.timestamp | date:'shortTime' }}</span>
          </div>
          <!-- Display human-readable tool call if present -->
          <div *ngIf="msg.humanReadableToolCall" class="tool-call-indicator">
            ‚öôÔ∏è {{ msg.humanReadableToolCall }}
          </div>
          <!-- New: Dynamic Buttons -->
          <div *ngIf="msg.dynamicButtons && msg.dynamicButtons.length > 0" class="dynamic-buttons">
            <button *ngFor="let btn of msg.dynamicButtons" (click)="handleDynamicButtonClick(btn.action, btn.payload)" class="dynamic-btn">
              {{ btn.text }}
            </button>
          </div>
          <!-- New: UI Elements -->
          <div *ngIf="msg.uiElements && msg.uiElements.length > 0" class="ui-elements-container">
            <ng-container *ngFor="let uiElement of msg.uiElements">
              <ng-container [ngSwitch]="uiElement.type">
                <app-product-card 
                  *ngSwitchCase="'product_card'" 
                  [product]="uiElement.data"
                  [showShareButton]="true"
                  [showAddToShoppingListButton]="true"
                  [showAddToFoodDiaryButton]="true"
                  (share)="shareProductFromConsole($event)"
                  (addToShoppingList)="addToShoppingListFromConsole($event)"
                  (addToFoodDiary)="addToFoodDiaryFromConsole($event)"
                  (viewDetails)="onViewDetailsFromConsole($event)">
                </app-product-card>
                <!-- Add more cases for other UI element types here -->
              </ng-container>
            </ng-container>
          </div>
          <!-- Suggested Prompts -->
          <div *ngIf="msg.suggestedPrompts && msg.suggestedPrompts.length > 0" class="suggested-prompts">
            <button *ngFor="let prompt of msg.suggestedPrompts" (click)="submitSuggestedPrompt(prompt)" class="suggested-prompt-btn">
              {{ prompt }}
            </button>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="msg.sender === 'user'">
        <div class="message-bubble">
          <p>{{ msg.text }}</p>
          <span class="timestamp">{{ msg.timestamp | date:'shortTime' }}</span>
        </div>
        <div class="avatar-container">
          <img [src]="msg.avatar" alt="User Avatar" class="avatar">
        </div>
      </ng-container>
    </div>
    <div *ngIf="isAgentTyping" class="message message-agent">
       <div class="avatar-container">
        <img [src]="agentAvatar" alt="Agent Avatar" class="avatar">
        <div class="status-dot" [ngClass]="agentStatus"></div>
      </div>
      <div class="agent-content">
        <div class="message-bubble typing-indicator">
          <span></span><span></span><span></span>
        </div>
      </div>
    </div>

    <!-- Integrated Camera Feed -->
    <div *ngIf="consoleCameraService.showCameraFeed" class="camera-integration-area">
      <app-camera-feed
        instanceId="chat-camera"
        (barcodeScanned)="consoleCameraService.handleBarcodeScanned($event)"
        (imageCaptured)="consoleCameraService.handleImageCaptured($event)"
        (cameraClosed)="consoleCameraService.closeCamera()">
      </app-camera-feed>
      <div class="camera-feedback">
        <p *ngIf="consoleCameraService.isProcessingCameraInput">Processing camera input...</p>
        <p *ngIf="!consoleCameraService.isProcessingCameraInput">Camera active. Scan a barcode or capture a label.</p>
      </div>
    </div>
  </div>

  <div class="input-area">
    <div *ngIf="showSlashCommands" class="slash-command-popup">
      <div *ngFor="let cmd of filteredCommands" class="command-item" (click)="selectCommand(cmd)">
        <strong>{{ cmd.command }}</strong>
        <span>{{ cmd.description }}</span>
      </div>
    </div>
    <div class="input-wrapper">
      <textarea 
        [(ngModel)]="userInput" 
        (ngModelChange)="handleInput()"
        (keydown.enter)="sendMessage(); $event.preventDefault()"
        placeholder="Type a command or message..."
        class="input-field">
      </textarea>
      <button (click)="toggleVoiceListening()" class="mic-btn" [class.active]="isListening" title="Use Voice">üé§</button>
      <button (click)="sendMessage()" class="send-btn" [disabled]="!userInput.trim()">‚Üí</button>
    </div>
  </div>
</div>